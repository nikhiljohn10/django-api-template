#!/bin/bash

ROOT_DIR=$(pwd)
APP_NAME=$(basename $ROOT_DIR)
APP_DIR=$(cd -P -- $ROOT_DIR/app 2>/dev/null && pwd)
BIN_DIR=$HOME/.django/$APP_NAME/bin
BIN_FILE=$BIN_DIR/api

_venv_init () {
	if [ ! -d "$APP_DIR/venv" ]; then
		printf "Do you wish to enable virtual environment for pip packages?(y/N): "
		read confirmation
		confirmation=$(echo $confirmation | tr '[:upper:]' '[:lower:]')
		case $confirmation in
			y | yes )
				python3 -m venv $APP_DIR/venv
				return $?
				;;
			* )
				echo "Python venv not installed"
				return 1
				;;
		esac
	fi
}

_build_api_bin () {
	[ ! -d "$BIN_DIR" ] && mkdir -p $BIN_DIR
	cp -f $APP_DIR/bin/lib $BIN_FILE
	sed -i "3iAPP_DIR=$APP_DIR" $BIN_FILE
	sed -i "3iROOT_DIR=$ROOT_DIR" $BIN_FILE
	chmod +x $BIN_FILE
}

_api_install () {
	if [ "$APP_DIR" != "" ]; then
		if [ ! -f $BIN_FILE ]; then
			_build_api_bin && echo "API Manager installed for $APP_NAME"
		else
			echo "API Manager for $APP_NAME exist"
		fi
		return 0
	else
		echo "App not found in the currect directory"
		return 1
	fi
}


_venv_init && [ -d "$APP_DIR/venv" ] && \. $APP_DIR/venv/bin/activate && \
_api_install && \
export ROOT_DIR=$ROOT_DIR && export APP_DIR=$APP_DIR && \
\. $BIN_FILE && api setup && api help && \
complete -W 'clean install migrate setup demo run deploy help' api
alias esc='deactivate'
